// Prisma Schema for Chad-Tutor
// Production-grade academic knowledge base with deduplication, caching, and analytics

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  LEARNER
  ADMIN
  MODERATOR
}

enum EnforcementLevel {
  LIGHT
  NORMAL
  AGGRESSIVE
}

enum RescheduleMode {
  AUTO
  MANUAL
  ASK
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum EntityType {
  UNIVERSITY
  COURSE
  SEMESTER
  SUBJECT
}

// ============================================================================
// SKILL ENUMS
// ============================================================================

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum SkillEdgeType {
  SUBSKILL_OF     // A is subskill of B (hierarchy via edges)
  PREREQUISITE    // A requires B to be completed first
  RELATED         // A and B are conceptually related
  ALTERNATIVE     // A is alternative approach to B
  BUILDS_ON       // A extends/advances B
  COMPLEMENTS     // A pairs well with B
}

enum SkillStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  MASTERED
}

enum MasteryLevel {
  NONE
  FAMILIAR
  COMPETENT
  PROFICIENT
  EXPERT
  MASTERED
}

enum SelectionSource {
  USER_SELECTED     // User explicitly picked this
  AI_RECOMMENDED    // AI suggested based on goals
  ROLE_REQUIRED     // Required for a role/career path
  GOAL_DERIVED      // Automatically added from goal definition
  PREREQUISITE      // Added because another skill requires it
}

// ============================================================================
// USER & AUTH MODELS
// ============================================================================

model User {
  id        String     @id @default(uuid())
  clerkId   String     @unique
  email     String     @unique
  name      String
  timezone  String     @default("UTC")
  roles     UserRole[] @default([LEARNER])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  settings         UserSettings?
  enforcement      Enforcement?
  goals            Goal[]
  settingsChanges  SettingsChangeLog[]
  searchLogs       SearchLog[]
  contentUsage     ContentUsage[]
  skillProgress    UserSkillProgress[]
  selectedSkills   UserSelectedSkill[]

  @@index([clerkId])
  @@index([email])
  @@index([createdAt])
}

model UserSettings {
  id        String   @id @default(uuid())
  userId    String   @unique
  
  // Availability
  activeDays       String[]  @default(["monday", "tuesday", "wednesday", "thursday", "friday"])
  dailyMinutes     Json      @default("{\"monday\":60,\"tuesday\":60,\"wednesday\":60,\"thursday\":60,\"friday\":60}")
  
  // Session behavior
  sessionDuration  Int       @default(25)
  breakFrequency   Int       @default(3)
  
  // Enforcement
  enforcementLevel EnforcementLevel @default(NORMAL)
  rescheduleMode   RescheduleMode   @default(AUTO)
  
  // Notifications
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(true)
  dailyReminder      Boolean @default(true)
  weeklyDigest       Boolean @default(true)
  missedTaskAlert    Boolean @default(true)
  
  // AI preferences
  aiExplanations     Boolean @default(true)
  aiQuizGeneration   Boolean @default(true)
  aiProgressInsights Boolean @default(true)
  
  // Privacy
  lastDataExport     DateTime?
  dataRetentionDays  Int      @default(90)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
}

model Enforcement {
  id        String   @id @default(uuid())
  userId    String   @unique
  
  violationCount   Int      @default(0)
  lastViolation    DateTime?
  violationHistory Json[]   @default([])
  isOnProbation    Boolean  @default(false)
  probationCount   Int      @default(0)
  probationStart   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([isOnProbation])
}

model Goal {
  id          String     @id @default(uuid())
  userId      String
  name        String
  description String?
  deadline    DateTime
  
  totalHours     Int        @default(0)
  completedHours Int        @default(0)
  status         GoalStatus @default(ACTIVE)
  
  milestones Json[] @default([])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId, status])
  @@index([deadline])
  @@index([status])
}

model SettingsChangeLog {
  id        String   @id @default(uuid())
  userId    String
  
  changes      Json[]
  impactScore  Int      @db.SmallInt
  warningLevel Int      @db.SmallInt
  
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId, createdAt])
}

// ============================================================================
// ACADEMIC CONTENT MODELS (with deduplication + canonical support)
// ============================================================================

model ExternalSource {
  id          String   @id @default(uuid())
  name        String   @unique
  apiEndpoint String?
  rateLimit   Int      @default(100) @db.SmallInt
  lastSync    DateTime?
  isActive    Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  universities University[]
  courses      Course[]
  semesters    Semester[]
  subjects     Subject[]

  @@index([isActive])
  @@index([lastSync])
}

model University {
  id           String   @id @default(uuid())
  externalId   String
  sourceId     String
  
  name           String  @db.VarChar(255)
  normalizedName String  @db.VarChar(255)
  country        String? @db.VarChar(100)
  type           String? @db.VarChar(100)

  // Hipolabs / provider-specific enrichment fields
  state     String? @db.VarChar(100)
  domain    String? @db.VarChar(255)
  webPage   String? @db.VarChar(500)
  alphaCode String? @db.VarChar(10)
  provider  String  @default("unknown") @db.VarChar(50)
  
  isCanonical  Boolean  @default(true)
  canonicalId  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  source    ExternalSource @relation(fields: [sourceId], references: [id], onDelete: Restrict)
  canonical University?    @relation("CanonicalUniversity", fields: [canonicalId], references: [id], onDelete: SetNull)
  duplicates University[]  @relation("CanonicalUniversity")
  courses   Course[]

  @@unique([sourceId, externalId])
  @@index([normalizedName, isCanonical])  // Fast search
  @@index([country, isCanonical])         // Country filter
  @@index([provider])                      // Provider filter
  @@index([isCanonical])
  @@index([sourceId])
  @@index([canonicalId])
}

model Course {
  id           String   @id @default(uuid())
  externalId   String
  sourceId     String
  universityId String
  
  name           String  @db.VarChar(255)
  normalizedName String  @db.VarChar(255)
  description    String? @db.Text
  duration       String? @db.VarChar(50)
  totalSemesters Int     @default(8) @db.SmallInt
  
  isCanonical  Boolean  @default(true)
  canonicalId  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  source     ExternalSource @relation(fields: [sourceId], references: [id], onDelete: Restrict)
  university University     @relation(fields: [universityId], references: [id], onDelete: Restrict)
  canonical  Course?        @relation("CanonicalCourse", fields: [canonicalId], references: [id], onDelete: SetNull)
  duplicates Course[]       @relation("CanonicalCourse")
  semesters  Semester[]

  @@unique([sourceId, externalId])
  @@unique([universityId, sourceId, externalId])
  @@index([normalizedName, isCanonical])
  @@index([universityId])
  @@index([sourceId])
  @@index([canonicalId])
}

model Semester {
  id         String   @id @default(uuid())
  externalId String
  sourceId   String
  courseId   String
  
  name     String @db.VarChar(100)
  number   Int    @db.SmallInt
  position Int    @default(0) @db.SmallInt
  
  isCanonical Boolean @default(true)
  canonicalId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  source    ExternalSource @relation(fields: [sourceId], references: [id], onDelete: Restrict)
  course    Course         @relation(fields: [courseId], references: [id], onDelete: Restrict)
  canonical Semester?      @relation("CanonicalSemester", fields: [canonicalId], references: [id], onDelete: SetNull)
  duplicates Semester[]    @relation("CanonicalSemester")
  subjects  Subject[]

  @@unique([courseId, sourceId, externalId])
  @@unique([courseId, number]) // Ensure unique semester numbers per course
  @@index([courseId])
  @@index([sourceId])
  @@index([number])
  @@index([canonicalId])
}

model Subject {
  id         String   @id @default(uuid())
  externalId String
  sourceId   String
  semesterId String
  
  name           String  @db.VarChar(255)
  normalizedName String  @db.VarChar(255)
  code           String? @db.VarChar(20)
  credits        Int     @default(0) @db.SmallInt
  marks          Int     @default(100) @db.SmallInt
  
  metadata Json?
  
  isCanonical Boolean @default(true)
  canonicalId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  source     ExternalSource @relation(fields: [sourceId], references: [id], onDelete: Restrict)
  semester   Semester       @relation(fields: [semesterId], references: [id], onDelete: Restrict)
  canonical  Subject?       @relation("CanonicalSubject", fields: [canonicalId], references: [id], onDelete: SetNull)
  duplicates Subject[]      @relation("CanonicalSubject")
  usage      ContentUsage[]

  @@unique([semesterId, sourceId, externalId])
  @@unique([semesterId, code]) // Ensure unique subject codes per semester
  @@index([normalizedName, isCanonical])
  @@index([semesterId])
  @@index([sourceId])
  @@index([code])
  @@index([canonicalId])
}

// ============================================================================
// CACHING & SEARCH MODELS
// ============================================================================

model SearchCache {
  id              String     @id @default(uuid())
  normalizedQuery String     @unique @db.VarChar(500)
  entityType      EntityType
  
  resultIds   String[] // @db.Uuid[] when Prisma supports it
  resultCount Int      @default(0) @db.SmallInt
  
  expiresAt DateTime
  hitCount  Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entityType, normalizedQuery])
  @@index([expiresAt])
  @@index([hitCount]) // For cache popularity analysis
}

model SearchLog {
  id        String   @id @default(uuid())
  userId    String?
  
  rawQuery        String     @db.VarChar(500)
  normalizedQuery String     @db.VarChar(500)
  entityType      EntityType
  
  cacheHit    Boolean @default(false)
  resultCount Int     @default(0) @db.SmallInt
  latencyMs   Int     @default(0) @db.SmallInt
  
  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([entityType, createdAt])
  @@index([cacheHit])
  @@index([latencyMs]) // For performance analysis
}

// ============================================================================
// FRESHNESS & REFRESH TRACKING
// ============================================================================

model ContentRefresh {
  id         String     @id @default(uuid())
  entityType EntityType
  entityId   String
  
  refreshedAt  DateTime @default(now())
  success      Boolean  @default(true)
  errorMessage String?  @db.Text
  
  previousHash String? @db.VarChar(64)
  newHash      String? @db.VarChar(64)
  hasChanges   Boolean @default(false)

  @@unique([entityType, entityId]) // Only one refresh record per entity
  @@index([entityType, refreshedAt])
  @@index([success])
  @@index([hasChanges])
}

// ============================================================================
// ANALYTICS & USAGE TRACKING
// ============================================================================

model ContentUsage {
  id        String   @id @default(uuid())
  userId    String
  subjectId String
  
  viewCount    Int      @default(1) @db.SmallInt
  totalViewMs  Int      @default(0) // Total time spent
  lastViewedAt DateTime @default(now())
  
  sessionId String? @db.VarChar(50)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Restrict)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@unique([userId, subjectId])
  @@index([userId, lastViewedAt])
  @@index([subjectId])
  @@index([lastViewedAt])
  @@index([sessionId])
}

// ============================================================================
// SKILLS - PURE GRAPH STRUCTURE
// ============================================================================

model SkillCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  sortOrder   Int      @default(0) @db.SmallInt
  
  skills      Skill[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([sortOrder])
}

model SkillTag {
  id    String  @id @default(uuid())
  name  String  @unique
  slug  String  @unique
  color String?
  
  skills Skill[]
  
  @@index([slug])
}

model Skill {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  normalizedName  String   @db.VarChar(255)
  description     String?  @db.Text
  icon            String?  @db.VarChar(50)
  color           String?  @db.VarChar(20)
  
  // Categorization
  category        SkillCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId      String
  tags            SkillTag[]
  
  // Difficulty (static metadata)
  difficulty      Difficulty @default(BEGINNER)
  
  // Canonical pattern (matches University/Course/Subject pattern)
  isCanonical     Boolean  @default(true)
  canonicalId     String?
  canonical       Skill?   @relation("CanonicalSkill", fields: [canonicalId], references: [id], onDelete: SetNull)
  variants        Skill[]  @relation("CanonicalSkill")
  
  // Graph edges (this skill as source)
  edgesFrom       SkillEdge[] @relation("EdgeSource")
  // Graph edges (this skill as target)
  edgesTo         SkillEdge[] @relation("EdgeTarget")
  
  // User relations
  userProgress    UserSkillProgress[]
  userSelections  UserSelectedSkill[]
  
  // Metadata
  isPublished     Boolean  @default(false)
  sortOrder       Int      @default(0) @db.SmallInt
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([categoryId])
  @@index([slug])
  @@index([normalizedName, isCanonical])
  @@index([canonicalId])
  @@index([difficulty])
  @@index([isPublished])
}

// Pure graph edges - Everything is an edge
model SkillEdge {
  id          String    @id @default(uuid())
  
  // Source skill (from)
  source      Skill     @relation("EdgeSource", fields: [sourceId], references: [id], onDelete: Cascade)
  sourceId    String
  
  // Target skill (to)
  target      Skill     @relation("EdgeTarget", fields: [targetId], references: [id], onDelete: Cascade)
  targetId    String
  
  // Edge type - THE KEY DIFFERENTIATOR
  edgeType    SkillEdgeType
  
  // Edge properties
  strength    Float     @default(1.0)
  isStrict    Boolean   @default(false)
  metadata    Json?
  
  createdAt   DateTime  @default(now())
  
  @@unique([sourceId, targetId, edgeType])
  @@index([sourceId, edgeType])
  @@index([targetId, edgeType])
  @@index([edgeType])
}

// ============================================================================
// USER SKILL PROGRESS (Behavioral data - separate from structure)
// ============================================================================

model UserSkillProgress {
  id        String @id @default(uuid())
  
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  
  skill     Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)
  skillId   String
  
  // Progress tracking
  status          SkillStatus  @default(NOT_STARTED)
  progressPercent Float        @default(0)
  
  // Performance
  masteryLevel    MasteryLevel @default(NONE)
  accuracyRate    Float        @default(0)
  
  // Streaks (computed per-skill)
  currentStreak   Int       @default(0) @db.SmallInt
  longestStreak   Int       @default(0) @db.SmallInt
  lastPracticed   DateTime?
  
  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
  @@index([status])
  @@index([lastPracticed])
}

// User's selected skills for learning path
model UserSelectedSkill {
  id        String   @id @default(uuid())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  skillId   String
  
  // How this skill was added to the user's path
  sourceType       SelectionSource @default(USER_SELECTED)
  
  // Include subskills when selected (via SUBSKILL_OF edges)
  includeSubskills Boolean @default(true)
  
  priority         Int     @default(0) @db.SmallInt
  
  createdAt DateTime @default(now())
  
  @@unique([userId, skillId])
  @@index([userId])
  @@index([sourceType])
}
